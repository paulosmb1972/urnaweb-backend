export default {
  async fetch(request, env) {
    // Cabeçalhos que liberam o acesso para qualquer origem (Resolve o erro de CORS)
    const corsHeaders = {
      "Access-Control-Allow-Origin": "*",
      "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
      "Access-Control-Allow-Headers": "Content-Type, admin",
    };

    // Responde a verificações prévias do navegador
    if (request.method === "OPTIONS") {
      return new Response(null, { headers: corsHeaders });
    }

    const url = new URL(request.url);

    // --- LÓGICA DO ADMINISTRADOR (LISTAR DADOS) ---
    if (request.method === "GET" && url.searchParams.get("admin") === "secret123") {
      try {
        const list = await env.URNA_STORAGE.list();
        const results = [];
        for (const key of list.keys) {
          const val = await env.URNA_STORAGE.get(key.name);
          results.push({ id: key.name, content: JSON.parse(val) });
        }
        return new Response(JSON.stringify(results), { 
          headers: { ...corsHeaders, "Content-Type": "application/json" } 
        });
      } catch (e) {
        return new Response("Erro no KV: " + e.message, { status: 500, headers: corsHeaders });
      }
    }

    // --- LÓGICA DE SALVAMENTO (POST) ---
    if (request.method === "POST") {
      try {
        const body = await request.json();
        const type = body.type || "voto";
        const id = `${type}_${Date.now()}`;
        
        // Salva no KV (Aqui usa o nome que você configurou no Binding)
        await env.URNA_STORAGE.put(id, JSON.stringify(body));
        
        return new Response(JSON.stringify({ status: "sucesso" }), { 
          headers: { ...corsHeaders, "Content-Type": "application/json" } 
        });
      } catch (e) {
        return new Response("Erro ao salvar: " + e.message, { status: 500, headers: corsHeaders });
      }
    }

    return new Response("UrnaWeb Ativo", { headers: corsHeaders });
  }
};
